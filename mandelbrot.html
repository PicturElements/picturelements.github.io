<!DOCTYPE html>
<html>
  <head>
    <title>Mandelbrot Generator - PicturElements</title>
    <link rel="icon" href="pelement.png">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,700" rel="stylesheet" type="text/css">
    
    <style>
      body{
        display: block;
        position: fixed;
        background-color: white;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      
      #mandelcanvas,#overlaycanvas{
        display:block;
        position:absolute;
        width:100%;
        height:100%;
        cursor:default;
      }
      
      #buttonpanel{
        display:block;
        position:fixed;
        height:4vw;
        min-width:10px;
        bottom:0;
        left:0;
        background-color:#ddd;
        padding-right:1vw;
      }
      
      #buttonpanel input{
        display:block;
        position:relative;
        padding-left:0.25vw;
        padding-right:0.25vw;
        float:left;
        left:1vw;
        margin-top:1vw;
        width:8vw;
        height:2vw;
        font-family:Roboto,Arial,sans-serif;
        font-size:1.5vw;
        font-weight:700;
        margin-right:1vw;
        border:0.1vw solid #aaa;
        background-color:white;
      }
      
      button{
        display: block;
        position: relative;
        float:left;
        width: 9vw;
        height: 2.3vw;
        margin-top: 1vw;
        cursor: pointer;
        font-size: 1.5vw;
        font-weight: bold;
        border: none;
        background-color: #999;
        color: #eee;
        margin-left:1vw;
      }
      
      button:hover{
        background-color:#888;
        color:#ddd;
      }
      
      #overlay{
        display:none;
        position:fixed;
        width:100%;
        height:100%;
        background-color:rgba(0,0,0,0.7);
      }
      
      #sharepanel,#functionpanel{
        display: none;
        position: fixed;
        width: 55%;
        left: 22.5%;
        height: 10vw;
        top: 50%;
        margin-top: -5vw;
        background-color: white;
        border-radius: 0.3vw;
        font-family: Roboto,Arial,sans-serif;
        font-weight: 700;
        font-size: 2vw;
        text-align: center;
        line-height: 5.5vw;
      }
      
      #functionin, #urlout{
        display: block;
        position: absolute;
        width: 90%;
        height: 2vw;
        font-family: Roboto,Arial,sans-serif;
        font-size: 1.2vw;
        font-weight: 700;
        left: 5%;
        top: 55%;
      }
      
      #closebtn{
        display: block;
        position: absolute;
        font-size: 1.3vw;
        color: #555;
        font-weight: 300;
        right: 0.7vw;
        top: 0.7vw;
        line-height: 1.5vw;
        cursor: pointer;
      }
    </style>
    <script>
      var xOff=200,yOff=0,zoom=3;
      var xOrig,yOrig,xRes,yRes,pressed=0;
      var width=window.innerWidth,height=window.innerHeight;
      var iterations=50;
      var a,b,a2,b2;
      var pixels=[];
      var scan=0,thread=null;
      var power=2,julA,julB,tmpPow,tmpJA,tmpJB,isMandel=1,tmpIsMandel=1;
      
      function init(){
        var canvas=document.getElementById("mandelcanvas");
        canvas.width=width;
        canvas.height=height;
        canvas.style.width=""+width+"px";
        canvas.style.height=""+height+"px";
        var canvas2=document.getElementById("overlaycanvas");
        canvas2.width=width;
        canvas2.height=height;
        canvas2.style.width=""+width+"px";
        canvas2.style.height=""+height+"px";
        mainGenerate();
      }
      
      function mainGenerate(){
        if (thread!=null){
          clearInterval(thread);
        }
        pixels=[];
        thread=setInterval(generate,10);   //set a low refresh time, let computer calculate as fast as it can. You go, little man!
      }
      
      function generate(){
        for (var h=scan;h<scan+10;h++){
          for (var w=0;w<width;w++){
            a2=(w-width/2-xOff/zoom)/(height/zoom);
            b2=(h-height/2-yOff/zoom)/(height/zoom);
            if (isMandel==1){
              a=a2;
              b=b2;
            }else{
              a=julA;
              b=-julB;
            }
            pixels.push(generateIndividual());
          }
        }
        paint();
        paint2();
        scan+=10;
      }
      
      function generateIndividual(){
        var aTmp;
        var v,magnitude;
        for (var i=0;i<iterations;i++){
          if (a2*a2+b2*b2>=4){
            return i;
          }
          if (power==2){
            aTmp=a2;
            a2=a2*a2-b2*b2+a;
            b2=aTmp*b2+b2*aTmp+b;
          }else{
            v=Math.atan(b2/a2);
            if (a2<0){v+=Math.PI;}
            v*=power;
            magnitude=Math.pow(Math.hypot(a2,b2),power)
            a2=magnitude*Math.cos(v)+a;
            b2=magnitude*Math.sin(v)+b;
          }
        }
        return -1;
      }
      
      function press(inId){
        pressed=inId;
        if (pressed==1){
          xOrig=event.clientX;
          yOrig=event.clientY;
        }
        paint2();
      }
      
      function drawRect(){
        xRes=event.clientX;
        yRes=event.clientY;
        paint2();
      }
      
      function setStuff(){
        iterations=parseInt(document.getElementById("iterations").value);
        xOff=parseFloat(document.getElementById("xOff").value);
        yOff=parseFloat(document.getElementById("yOff").value);
        zoom=parseFloat(document.getElementById("zoom").value);
        if (iterations==null||iterations==undefined){iterations=0;}
        else if (xOff==null||xOff==undefined){xOff=0;}
        else if (yOff==null||yOff==undefined){yOff=0;}
        else if (zoom==null||zoom==undefined){yOff=0;}
        scan=0;
        mainGenerate();
      }
      
      function setFunction(){
        document.getElementById("overlay").style.display="block";
        document.getElementById("functionpanel").style.display="block";
      }
      
      function getUrl(){
        document.getElementById("overlay").style.display="block";
        document.getElementById("sharepanel").style.display="block";
        document.getElementById("urlout").select;
      }
      
      function closePopups(inId){
        document.getElementById("overlay").style.display="none";
        if (inId==0){
          document.getElementById("functionpanel").style.display="none";
        }else{
          document.getElementById("sharepanel").style.display="none";
        }
      }
      
      function displayFunction(){
        tmpPow=2;
        tmpJA=0;
        tmpJB=0;
        var input=document.getElementById("functionin").value;
        var values=[],foundNumber=0,prevWasNo=0,tmpString="";
        for (var i=0;i<input.length;i++){
          if (isNumber(input.charAt(i))){
            if (foundNumber==0&&input.charAt(i-1)=='-'){tmpString="-";}
            tmpString+=input.charAt(i);
            foundNumber=1;
            prevWasNo=1;
          }else{
            if (prevWasNo==1){
              prevWasNo=0;
              foundNumber=0;
              values.push(parseFloat(tmpString));
              tmpString="";
            }
          }
        }
        if (prevWasNo==1){values.push(parseFloat(tmpString));}
        tmpIsMandel=0;
        if (values.length==1){
          tmpIsMandel=1;
          tmpPow=Math.abs(Math.floor(values[0]));
        }else if(values.length==2){
          tmpPow=Math.abs(Math.floor(values[0]));
          if (input.endsWith("i")){
            tmpJA=0;
            tmpJB=values[1];
          }else{
            tmpJA=values[1];
            tmpJB=0;
          }
        }else if(values.length==3){
          tmpPow=Math.abs(Math.floor(values[0]));
          tmpJA=values[1];
          tmpJB=values[2];
        }
        var tA="+"+tmpJA,tB="+"+tmpJB;
        if (tmpJA<0){tA=tmpJA;}
        if (tmpJB<0){tB=tmpJB;}
        console.log("Function: z^"+tmpPow+""+tA+""+tB+"i");
        if (tmpIsMandel==1||tmpJA==0&&tmpJB==0){
          document.getElementById("funcout").innerHTML="Function: z^"+tmpPow+"+c (Mandelbrot set)";
        }else{
          document.getElementById("funcout").innerHTML="Function: z^"+tmpPow+""+tA+""+tB+"i (Julia set)";
        }
      }
      
      function isNumber(inChar){
        for (var a=0;a<10;a++){
          if (inChar==a){return true;}
        }
        if (inChar=="."){return true;}
        return false;
      }
      
      function pushFunction(){
        closePopups(0);
        isMandel=tmpIsMandel;
        power=tmpPow;
        julA=tmpJA;
        julB=tmpJB;
        scan=0;
        mainGenerate();
      }
      
      function paint(){
        var shade;
        var ctx=document.getElementById("mandelcanvas").getContext("2d");
        for (var h=scan;h<scan+10;h++){
          for (var w=0;w<width;w++){
            if (pixels[h*width+w]==-1){
              ctx.fillStyle="black";
              ctx.fillRect(w,h,1,1);
            }else{
              shade=Math.floor((iterations-pixels[h*width+w])/iterations*255);
              ctx.fillStyle="rgb("+shade+","+shade+","+shade+")";
              ctx.fillRect(w,h,1,1);
            }
          }
        }
        if (scan>=window.innerHeight){
          clearInterval(thread);
        }
      }
      
      function paint2(){
        var ctx2=document.getElementById("overlaycanvas").getContext("2d");
        ctx2.clearRect(0,0,window.innerWidth,window.innerHeight);
        ctx2.strokeStyle="red";
        if (pressed==1){
          ctx2.beginPath();
          ctx2.rect(xOrig,yOrig,xRes-xOrig,yRes-yOrig);
          ctx2.stroke();
        }
        if (thread!=null){
          ctx2.beginPath();
          ctx2.moveTo(0,scan+10);
          ctx2.lineTo(window.innerWidth,scan+10);
          ctx2.stroke();
        }
      }
    </script>
  </head>
  <body onload=init()>
    <canvas id="mandelcanvas"></canvas>
    <canvas id="overlaycanvas" onmousedown=press(1) onmousemove=drawRect() onmouseup=press(0)></canvas>
    <div id="buttonpanel">
      <input id="iterations" value="50"></input>
      <input id="xOff" value="200"></input>
      <input id="yOff" value="0"></input>
      <input id="zoom" value="3"></input>
      <button id="generate" onclick=setStuff()>Generate</button>
      <button id="function" onclick=setFunction()>Function</button>
      <button id="geturl" onclick=getUrl()>Get URL</button>
    </div>
    <div id="overlay">
      <div id="functionpanel" style="height:14vw; margin-top:-7vw">
        Modify Mandelbrot/Julia set function
        <div id="closebtn" onclick="closePopups(0)">[close]</div>
        <input id="functionin" value="z^2+c" spellcheck="false" style="width:62.5%; top:5.5vw" onkeyup=displayFunction()>
        <button style="margin-top:0; position:absolute; width:12vw; margin-left:40vw;" onclick=pushFunction()>Set function</button>
        <div id="funcout" style="display: block; position: absolute; font-size: 1.3vw; color: #999; width: 90%; margin-left: 5%; height: 3vw; line-height: 3vw; background-color: #ddd; margin-top: 4vw;">Function: z^2+c (Mandelbrot set)</div>
      </div>
      <div id="sharepanel">
        Share you Mandelbrot/Julia set!
        <div id="closebtn" onclick="closePopups(1)">[close]</div>
        <input id="urlout" spellcheck="false">
      </div>
    </div>
  </body>
</html>
