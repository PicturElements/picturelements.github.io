<!DOCTYPE html>
<html>
  <head>
    <title>Mandelbrot Generator - PicturElements</title>
    <link rel="icon" href="pelement.png">
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,700" rel="stylesheet" type="text/css">
    <style>
      body{
        display: block;
        position: fixed;
        background-color: white;
        margin: 0;
        height: 100%;
        width: 100%;
      }
      
      #rastercanvas,#mandelcanvas,#overlaycanvas{
        display:block;
        position:absolute;
        width:100%;
        height:100%;
        cursor:default;
      }
      
      #rastercanvas{
        background-color:#ddd;
      }
      
      #buttonpanel{
        display:block;
        position:fixed;
        height:5.5vw;
        min-width:10px;
        bottom:0;
        left:0;
        background-color:#ddd;
        padding-right:1vw;
        transition:margin-left 500ms;
      }
      
      #toolbox{
        display: block;
        position: absolute;
        min-width: 20px;
        height: 2vw;
        background-color: #999;
        font-family: Roboto,Arial,sans-serif;
        font-weight: bold;
        font-size:1.5vw;
        color: #eee;
        line-height: 2vw;
        padding-left: 0.5vw;
        padding-right: 0.5vw;
        margin-top: -2vw;
        cursor: pointer;
        font-size:1.5vw;
      }
      
      #toolbox:hover{
        background-color:#888;
        color:#ddd;
      }
      
      #titlebox{
        display:block;
        position:absolute;
        left:0;
        top:0;
        width:100%;
        height:2vw;
      }
      
      #title,#title2{
        display: block;
        position: relative;
        float: left;
        width: 8.65vw;
        height: 2vw;
        font-family: Roboto;
        line-height: 3vw;
        left: 1vw;
        margin-right: 1vw;
        font-size:1vw;
      }
      
      #title2{
        width:9vw;
      }
      
      #buttonpanel input{
        display:block;
        position:relative;
        padding-left:0.25vw;
        padding-right:0.25vw;
        float:left;
        left:1vw;
        margin-top:2.5vw;
        width:8vw;
        height:2vw;
        font-family:Roboto,Arial,sans-serif;
        font-size:1.5vw;
        font-weight:700;
        margin-right:1vw;
        border:0.1vw solid #aaa;
        background-color:white;
      }
      
      button{
        display: block;
        position: relative;
        float:left;
        width: 9vw;
        height: 2.3vw;
        margin-top: 2.5vw;
        cursor: pointer;
        font-size: 1.5vw;
        font-weight: bold;
        border: none;
        background-color: #999;
        color: #eee;
        margin-left:1vw;
      }
      
      button:hover{
        background-color:#888;
        color:#ddd;
      }
      
      #expando{
        display: block;
        position: absolute;
        width: 3vw;
        height: 5.5vw;
        background-color: #444;
        margin-left: 100%;
        cursor: pointer;
        font-family: Roboto;
        color: white;
        font-size: 2vw;
        text-align: center;
        line-height: 5.5vw;
      }
      
      #overlay{
        display:none;
        position:fixed;
        width:100%;
        height:100%;
        background-color:rgba(0,0,0,0.7);
        z-index:100;
      }
      
      #sharepanel,#functionpanel,#functionpanel2{
        display: none;
        position: fixed;
        width: 55%;
        left: 22.5%;
        height: 10vw;
        top: 50%;
        margin-top: -5vw;
        background-color: white;
        border-radius: 0.3vw;
        font-family: Roboto,Arial,sans-serif;
        font-weight: 700;
        font-size: 2vw;
        text-align: center;
        line-height: 5.5vw;
      }
      
      #functionin, #functionin2, #urlout{
        display: block;
        position: absolute;
        width: 90%;
        height: 2vw;
        font-family: Roboto,Arial,sans-serif;
        font-size: 1.2vw;
        font-weight: 700;
        left: 5%;
        top: 55%;
      }
      
      #closebtn{
        display: block;
        position: absolute;
        font-size: 1.3vw;
        color: #555;
        font-weight: 300;
        right: 0.7vw;
        top: 0.7vw;
        line-height: 1.5vw;
        cursor: pointer;
      }
      
      #colorpanel{
        display:none;
        position: fixed;
        width: 40%;
        left: 30%;
        height: 30vw;
        top: 50%;
        margin-top: -15vw;
        background-color: white;
        border-radius: 0.25vw;
      }
      
      .gradientselector{
        display: block;
        position: relative;
        float: left;
        width: 6vw;
        height: 6vw;
        box-sizing: content-box;
        border: 0.5vw outset #ccc;
        background-color: #ddd;
        left: 0.833vw;
        top: 0.833vw;
        margin-right: 0.97vw;
        margin-bottom: 0.833vw;
        cursor: pointer;
      }
      
      .gradientselector:hover{
        border-color:#999;
      }
      
      #gradientdisplay{
        display: block;
        position: absolute;
        width: 37.333vw;
        height: 5vw;
        background-color: #ddd;
        border: 0.5vw outset #ccc;
        left: 0.833vw;
        margin-top: 16.3vw;
      }
      
      #hoverinfo{
        display: none;
        position: fixed;
        height: 70px;
        min-width: 70px;
        overflow: hidden;
        background-color: white;
        padding-right: 10px;
        border: 2px solid #444;
      }
      
      #colorsample{
        display: block;
        position: absolute;
        width: 50px;
        height: 50px;
        margin-top: 7px;
        margin-left: 7px;
        background-color: red;
        border: 3px solid #444;
      }
      
      #iterationinfo,#iterationinfo2{
        display: block;
        position: relative;
        height: 70px;
        font-family: Roboto;
        font-weight: 700;
        font-size: 25px;
        color: #333;
        margin-left: 70px;
        margin-top: 5px;
      }
      
      #iterationinfo2{
        font-size: 10px;
        margin-top: -40px;
      }
      
      #upperinfo{
        display: none;
        position: absolute;
        width: 100%;
        text-align: center;
        font-family: Roboto,Arial,sans-serif;
        color: white;
        top: 0.5vw;
        padding-top: 0.5vw;
        padding-bottom: 0.5vw;
        font-size: 1.2vw;
        background-color: rgba(0,0,0,0.4);
        text-shadow: 0 0 2px black, 0 0 2px black,0 0 2px black, 0 0 2px black;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ie-user-select: none;
        pointer-events: none;
      }
      
      #infocontainer{
        display: none;
        position: fixed;
        width:70%;
        left:15%;
        height:80%;
        top:10%;
        margin-top:0;
        background-color: white;
        border-radius: 0.3vw;
        font-family: Roboto,Arial,sans-serif;
        font-weight: 700;
        font-size: 2vw;
        text-align: center;
        line-height: 5.5vw;
      }
      
      #inner{
        display:block;
        position:absolute;
        font-family:inherit;
        width:calc(100% - 6vw);
        height:calc(100% - 6vw);
        top:3vw;
        left:3vw;
        background-color:#eee;
        overflow-x:hidden;
        overflow-y:scroll;
      }
      
      #inner h,#inner h2{
        font-family:inherit;
        font-size:2vw;
        font-weight:700;
      }
      
      #inner h2{
        border-top: 1px solid #ddd;
        width: 90%;
        margin-left: 5%;
        margin-top:3vw;
      }
      
      #inner p{
        display: block;
        position: relative;
        width: 97%;
        left: 1.5%;
        font-size: 1.2vw;
        font-weight: 300;
        line-height: 1.3vw;
        text-align: left;
      }
    </style>
    <script>
      var xOff=300,yOff=0,zoom=3,iterations=50,mode=0,prevH=0;
      var xOrig,yOrig,xRes,yRes,pressed=false,expanded=true,display=false,move=false,advancedGen=false,functionNo=0;
      var width=window.innerWidth,height=window.innerHeight;
      var cmx=0,cmy=0,curX,curY,tmpXOff,tmpYOff,tmpZoom;
      var a,b,a2,b2;
      var pixels=[];
      var scan=0,thread=null;
      var power=2,julA,julB,tmpPow,tmpJA,tmpJB,isMandel=true,tmpIsMandel=true,isAdvanced,containsXY;
      var gradientCols=[255,255,255,0,0,0,255,0,0,0,0,0,0,255,0,0,0,0,0,0,255,0,0,0,255,0,0,0,255,0,0,0,255,0,0,50,179,216,253,255,255,255,255,194,0,140,46,0];
      //               |                 |             |             |             |                       |
      var startAt=[0,6,12,18,24,33,48];
      var selectedCol=5,rd,gr,bl,cycleLength=50;
      var date=new Date(),time=date.getTime();
      var ctx,imgData,ctx2;
      var expressions=["PI","E","pow","sqrt","cbrt","sin","cos","tan","floor","abs","ceil","random","log","log10","exp"];
      
      function init(){
        ctx2=document.getElementById("overlaycanvas").getContext("2d");
        var canvas=document.getElementById("mandelcanvas");
        canvas.width=width;
        canvas.height=height;
        canvas.style.width=""+width+"px";
        canvas.style.height=""+height+"px";
        var canvas2=document.getElementById("overlaycanvas");
        canvas2.width=width;
        canvas2.height=height;
        canvas2.style.width=""+width+"px";
        canvas2.style.height=""+height+"px";
        var canvas2=document.getElementById("rastercanvas");
        canvas2.width=width;
        canvas2.height=height;
        canvas2.style.width=""+width+"px";
        canvas2.style.height=""+height+"px";
        paintRaster();
        gradientSetup();
        var parts=(startAt[selectedCol+1]-startAt[selectedCol])/3+1;
        var colors="";
        for (var b=0;b<parts-1;b++){
          colors+="rgb("+(gradientCols[startAt[selectedCol]+3*b])+","+(gradientCols[startAt[selectedCol]+3*b+1])+","+(gradientCols[startAt[selectedCol]+3*b+2])+") "+(b*(100/(parts-1)))+"%, ";
        }
        colors+="rgb("+(gradientCols[startAt[selectedCol]])+","+(gradientCols[startAt[selectedCol]+1])+","+(gradientCols[startAt[selectedCol]+2])+") 100%";
        document.getElementById("gradientdisplay").style.background="linear-gradient(to right, "+colors+")";
        if (!parseUrl()){
          setStuff();
        }
        displayFunction();
        pushFunction(0);
      }
      
      function paintRaster(){
        var ctx=document.getElementById("rastercanvas").getContext("2d");
        ctx.fillStyle="#777";
        var sqS=7;
        for (var h=0;h<window.innerHeight+sqS;h+=sqS){
          for (var w=0;w<window.innerWidth+sqS;w+=2*sqS){
            ctx.fillRect(((h/sqS)%2)*sqS+w,h,sqS,sqS);
          }
        }
      }
      
      function parseUrl(){
        var tmpStr="";
        var count=0,url=window.location.href;
        var foundQuest=false,toScan=false;
        for (var i=0;i<url.length;i++){
          if (url.charAt(i)=='?'){foundQuest=true;}
          if (foundQuest){
            if (url.charAt(i)=='='){toScan=true;}
            else if (url.charAt(i)=='&'||i==url.length-1){
              if (i==url.length-1){tmpStr+=url.charAt(i);}
              toScan=false;
              if (count==0){document.getElementById("functionin").value=tmpStr;}
              else if (count==1){document.getElementById("iterations").value=tmpStr;}
              else if (count==2){document.getElementById("xOff").value=tmpStr;}
              else if (count==3){document.getElementById("yOff").value=tmpStr;}
              else if (count==4){document.getElementById("zoom").value=tmpStr;}
              else if (count==5){prevH=parseInt(tmpStr);}
              count++;
              tmpStr="";
            }else if(toScan){
              tmpStr+=url.charAt(i);
            }
          }
        }
        if (foundQuest){
          document.getElementById("zoom").value=parseFloat(document.getElementById("zoom").value)*(prevH/height);
          /*document.getElementById("xOff").value=parseFloat(document.getElementById("xOff").value)*(prevH/height);
          document.getElementById("yOff").value=parseFloat(document.getElementById("yOff").value)*(prevH/height);*/
        }
        return foundQuest;
      }
      
      function gradientSetup(){
        for (var a=0;a<startAt.length-1;a++){
          var parts=(startAt[a+1]-startAt[a])/3;
          var colors="";
          for (var b=0;b<parts-1;b++){
            colors+="rgb("+(gradientCols[startAt[a]+3*b])+","+(gradientCols[startAt[a]+3*b+1])+","+(gradientCols[startAt[a]+3*b+2])+") "+(b*(100/(parts-1)))+"%, ";
          }
          colors+="rgb("+(gradientCols[startAt[a]+3*(parts-1)])+","+(gradientCols[startAt[a]+3*(parts-1)+1])+","+(gradientCols[startAt[a]+3*(parts-1)+2])+") 100%";
          document.getElementsByClassName("gradientselector")[a].style.background="linear-gradient(to bottom right, "+colors+")";
          console.log("linear-gradient(to bottom right, "+colors+")");
        }
      }
      
      function gradient(inID){
        var parts=(startAt[inID+1]-startAt[inID])/3+1;
        var colors="";
        for (var b=0;b<parts-1;b++){
          colors+="rgb("+(gradientCols[startAt[inID]+3*b])+","+(gradientCols[startAt[inID]+3*b+1])+","+(gradientCols[startAt[inID]+3*b+2])+") "+(b*(100/(parts-1)))+"%, ";
        }
        colors+="rgb("+(gradientCols[startAt[inID]])+","+(gradientCols[startAt[inID]+1])+","+(gradientCols[startAt[inID]+2])+") 100%";
        document.getElementById("gradientdisplay").style.background="linear-gradient(to right, "+colors+")";
        selectedCol=inID;
        closePopups(3);
        if (thread!=null){
          clearInterval(thread);
        }
        if (mode==3){mode=0;}
        date=new Date();
        time=-date.getTime();
        scan=0;
        thread=setInterval(recolor,1);
      } 
      
      function mainGenerate(){
        ctx=document.getElementById("mandelcanvas").getContext("2d");
        imgData=ctx.createImageData(width,10);
        scan=0;
        if (mode==3){mode=0;}
        document.getElementById("mandelcanvas").style.marginLeft="0";
        document.getElementById("mandelcanvas").style.marginTop="0";
        tmpXOff=parseFloat(document.getElementById("xOff").value);
        tmpYOff=parseFloat(document.getElementById("yOff").value);
        tmpZoom=parseFloat(document.getElementById("zoom").value);
        cmx=0;
        cmy=0;
        if (thread!=null){
          clearInterval(thread);
        }
        pixels=[];
        thread=setInterval(generate,1);   //set a low refresh time, let computer calculate as fast as it can. You go, little man!
      }
      
      function generate(){
        var rescale=1;
        if (prevH>0){
          rescale=prevH/height;
        }
        for (var h=scan;h<scan+10;h++){
          for (var w=0;w<width;w++){
            a2=(w-width/2-xOff/zoom)/(500/zoom);
            b2=(h-height/2-yOff/zoom)/(500/zoom);
            if (isMandel){
              a=a2;
              b=b2;
            }else{
              if (advancedGen){redirect(a2,b2);}
              a=julA;
              b=-julB;
            }
            pixels.push(generateIndividual(0));
          }
        }
        paint();
        paint2();
        scan+=10;
      }
      
      function generateIndividual(type){
        var aTmp;
        var v,magnitude;
        for (var i=0;i<iterations;i++){
          if (a2*a2+b2*b2>=4){
            //return i;
            //return i+1-Math.log(Math.log(Math.hypot(a2,b2)))/Math.log(power);
            //return i+(i+1-Math.log(Math.log(Math.sqrt(a2*a2+b2*b2)))/Math.log(2))/iterations;
            //return i+1-Math.log(Math.log(Math.sqrt(a2*a2+b2*b2))/Math.log(2))/Math.log(2);
            return i+1-Math.log(Math.log(Math.sqrt(a2*a2+b2*b2)))/Math.log(power);
            //return i+1-Math.log((Math.log(a2*a2+b2*b2)/2)/Math.log(2))/Math.log(2);
            //return i+1-(Math.log(Math.log(Math.sqrt(a2*a2+b2*b2))/Math.log(10)/Math.log(10)))/(Math.log(power)/Math.log(10));
          }
          if (power==2){
            aTmp=a2;
            a2=a2*a2-b2*b2+a;
            b2=aTmp*b2+b2*aTmp+b;
          }else{
            v=Math.atan(b2/a2);
            if (a2<0){v+=Math.PI;}
            v*=power;
            magnitude=Math.pow(Math.hypot(a2,b2),power)
            a2=magnitude*Math.cos(v)+a;
            b2=magnitude*Math.sin(v)+b;
          }
          if (type==1){
            ctx2.lineTo(a2*(height/zoom)+xOff/zoom+width/2,b2*(height/zoom)+yOff/zoom+height/2);
          }
        }
        return -1;
      }
      
      function isHotkey(keycode){
        var hotkeys=[83,77,73,71,70,69,67,85,27,13];
        for (var i=0;i<hotkeys.length;i++){
          if (keycode==hotkeys[i]){return true;}
        }
        return false;
      }
      
      function setMode(){
        if (!display){
          if (isHotkey(event.keyCode)){
            document.getElementById("generate").focus();
          }
          document.getElementById("upperinfo").style.display="none";
          var hi=document.getElementById("hoverinfo").style;
          hi.left="-1000px";
          hi.top="-1000px";
          hi.display="none";
          var kc=event.keyCode;
          if (kc==83){
            document.getElementById("overlaycanvas").style.cursor="default";
            mode=0;
          }else if (kc==77){
            document.getElementById("overlaycanvas").style.cursor="move";
            mode=1;
          }else if (kc==73){
            document.getElementById("overlaycanvas").style.cursor="default";
            document.getElementById("hoverinfo").style.display="block";
            mode=2;
          }else if (kc==69){
            document.getElementById("overlaycanvas").style.cursor="default";
            mode=3;
          }else if(kc==71){   //G - generate
            closePopups(-1);
            setStuff();
          }else if(kc==70){   //F - function
            closePopups(-1);
            setFunction();
            display=true;
          }else if(kc==67){   //C - colors
            closePopups(-1);
            setColor();
          }else if(kc==85){   //U - URL
            closePopups(-1);
            display=true;
            setTimeout(getUrl,100);
          }else if(kc==27){   //ESC
            closePopups(-1);
          }else if(kc==13&&mode==0&&move){   //Enter-generate
            setStuff();
          }
          if(kc==27&&mode==0&&xRes>0&&yRes>0&&move){   //Esc
            xRes=0;
            yRes=0;
            paint2();
            document.getElementById("zoom").value=tmpZoom;
            document.getElementById("xOff").value=tmpXOff;
            document.getElementById("yOff").value=tmpYOff;
            document.getElementById("overlaycanvas").style.cursor="default";
          }
        }else if(event.keyCode==27){   //ESC
          closePopups(-1);
        }
        move=false;
      }
      
      function press(inId){
        pressed=inId;
        if (pressed&&mode==0&&!move){
          xOrig=event.clientX;
          yOrig=event.clientY;
          xRes=0;
          yRes=0;
          document.getElementById("zoom").value=tmpZoom;
        }else if (pressed&&mode==1||pressed&&move){
          curX=event.clientX;
          curY=event.clientY;
        }
        if (!pressed&&mode==0&&xRes>0&&yRes>0){
          document.getElementById("overlaycanvas").style.cursor="move";
          document.getElementById("upperinfo").style.display="block";
          document.getElementById("upperinfo").innerHTML="Esc - Cancel | Enter - Generate | Drag to reposition";
          move=true;
        }
        paint2();
      }
      
      function canvasInteract(){
        if (mode==0&&pressed&&!move){
          xRes=event.clientX-xOrig;
          yRes=(xRes)*(height/width);
          if (xRes>0&&yRes>0){
            document.getElementById("zoom").value=tmpZoom*(xRes/window.innerWidth);
            document.getElementById("xOff").value=tmpXOff+(window.innerWidth/2-(xOrig-cmx+xRes/2))*zoom;
            document.getElementById("yOff").value=tmpYOff+(window.innerHeight/2-(yOrig-cmy+yRes/2))*zoom;
          }else{
            document.getElementById("zoom").value=tmpZoom;
            document.getElementById("xOff").value=tmpXOff;
            document.getElementById("yOff").value=tmpYOff;
          }
        }else if(move&&pressed){
          document.getElementById("xOff").value=(parseFloat(document.getElementById("xOff").value)-(event.clientX-curX)*zoom);
          document.getElementById("yOff").value=(parseFloat(document.getElementById("yOff").value)-(event.clientY-curY)*zoom);
          xOrig+=(event.clientX-curX);
          yOrig+=(event.clientY-curY);
          paint2();
          curX=event.clientX;
          curY=event.clientY;
        }else if (mode==1&&pressed){
          cmx+=(event.clientX-curX);
          cmy+=(event.clientY-curY);
          curX=event.clientX;
          curY=event.clientY;
          document.getElementById("mandelcanvas").style.marginLeft=""+cmx+"px";
          document.getElementById("mandelcanvas").style.marginTop=""+cmy+"px";
          document.getElementById("xOff").value=tmpXOff+cmx*zoom;
          document.getElementById("yOff").value=tmpYOff+cmy*zoom;
        }else if(mode==2){
          document.getElementById("hoverinfo").style.left=""+(event.clientX+20)+"px";
          document.getElementById("hoverinfo").style.top=""+(event.clientY+20)+"px";
          var pos=(event.clientY-cmy)*width+(event.clientX-cmx);
          var hi=document.getElementById("hoverinfo");
          hi.style.right="initial";
          hi.style.bottom="initial";
          if (event.clientX-cmx<0||event.clientY-cmy<0||event.clientX-cmx>width||event.clientY-cmy>height){
            hi.style.left="-1000px";
            hi.style.top="-1000px";
          }else{
            color(pos);
            var iters=Math.floor(pixels[pos]);
            if (iters==-1){
              iters=iterations;
              document.getElementById("colorsample").style.backgroundColor="black";
            }else{
              document.getElementById("colorsample").style.backgroundColor="rgb("+Math.floor(rd)+","+Math.floor(gr)+","+Math.floor(bl)+")";
            }
            document.getElementById("iterationinfo").innerHTML="Iterations: "+iters;
            document.getElementById("iterationinfo2").innerHTML="Re: "+(event.clientX-cmx-width/2-xOff/zoom)/(height/zoom)+"<br>Im: "+(-(event.clientY-cmy-height/2-yOff/zoom)/(height/zoom));
            if (event.clientX+hi.offsetWidth+40>window.innerWidth){
              hi.style.left="initial";
              hi.style.right=""+(window.innerWidth-event.clientX+20)+"px";
            }
            if (event.clientY+hi.offsetHeight+40>window.innerHeight){
              hi.style.top="initial";
              hi.style.bottom=""+(window.innerHeight-event.clientY+20)+"px";
            }
          }
        }
        paint2();
      }
      
      function setStuff(){
        document.getElementById("upperinfo").style.display="none";
        xRes=0;
        yRes=0;
        if (move){
          paint2();
          document.getElementById("overlaycanvas").style.cursor="default";
          move=false;
        }
        iterations=parseInt(document.getElementById("iterations").value);
        xOff=parseFloat(document.getElementById("xOff").value);
        yOff=parseFloat(document.getElementById("yOff").value);
        zoom=parseFloat(document.getElementById("zoom").value);
        if (iterations==null||iterations==undefined){iterations=0;}
        else if (xOff==null||xOff==undefined){xOff=0;}
        else if (yOff==null||yOff==undefined){yOff=0;}
        else if (zoom==null||zoom==undefined){yOff=0;}
        scan=0;
        date=new Date();
        time=date.getTime();
        mainGenerate();
      }
      
      function openToolbox(){
        document.getElementById("overlay").style.display="block";
        document.getElementById("infocontainer").style.display="block";
      }
      
      function setFunction(){
        display=true;
        document.getElementById("overlay").style.display="block";
        document.getElementById("functionpanel").style.display="block";
      }
      
      function setColor(){
        document.getElementById("overlay").style.display="block";
        document.getElementById("colorpanel").style.display="block";
      }
      
      function getUrl(){
        display=true;
        document.getElementById("overlay").style.display="block";
        document.getElementById("sharepanel").style.display="block";
        var url="http://picturelements.github.io/mandelbrot?func="+document.getElementById("functionin").value+"&iters="+document.getElementById("iterations").value+"&xOff="+document.getElementById("xOff").value+"&yOff="+document.getElementById("yOff").value+"&zoom="+document.getElementById("zoom").value+"&prevH="+height;
        document.getElementById("urlout").value=url;
        document.getElementById("urlout").select();
      }
      
      function setAdvanced(){
        document.getElementsByClassName("popup")[0].style.display="none";
        document.getElementById("functionpanel2").style.display="block";
      }
      
      function goBack(){
        document.getElementsByClassName("popup")[1].style.display="none";
        document.getElementById("functionpanel").style.display="block";
      }
      
      function closePopups(inId){
        display=false;
        document.getElementById("overlay").style.display="none";
        if (inId==-1){    //closes EVERYTHING
          var popups=document.getElementsByClassName("popup");
          for (var i=0;i<popups.length;i++){
            popups[i].style.display="none";
          }
        }else{
          document.getElementsByClassName("popup")[inId].style.display="none";
        }
      }
      
      function expando(){
        if (expanded){
          document.getElementById("buttonpanel").style.marginLeft="-"+(document.getElementById("buttonpanel").offsetWidth)+"px";
        }else{
          document.getElementById("buttonpanel").style.marginLeft="0";
        }
        expanded=!expanded;
      }
      
      function displayFunction(){
        if (!advancedGen){
          tmpPow=2;
          tmpJA=0;
          tmpJB=0;
          var input=document.getElementById("functionin").value;
          var values=[],foundNumber=false,prevWasNo=false,tmpString="";
          for (var i=0;i<input.length;i++){
            if (isNumber(input.charAt(i))){
              if (!foundNumber&&input.charAt(i-1)=='-'){tmpString="-";}
              tmpString+=input.charAt(i);
              foundNumber=true;
              prevWasNo=true;
            }else{
              if (prevWasNo==true){
                prevWasNo=false;
                foundNumber=false;
                values.push(parseFloat(tmpString));
                tmpString="";
              }
            }
          }
          if (prevWasNo){values.push(parseFloat(tmpString));}
          tmpIsMandel=0;
          if (values.length==1){
            tmpIsMandel=true;
            tmpPow=Math.abs(Math.floor(values[0]));
          }else if(values.length==2){
            tmpPow=Math.abs(Math.floor(values[0]));
            if (input.endsWith("i")){
              tmpJA=0;
              tmpJB=values[1];
            }else{
              tmpJA=values[1];
              tmpJB=0;
            }
          }else if(values.length==3){
            tmpPow=Math.abs(Math.floor(values[0]));
            tmpJA=values[1];
            tmpJB=values[2];
          }
          var tA="+"+tmpJA,tB="+"+tmpJB;
          if (tmpJA<0){tA=tmpJA;}
          if (tmpJB<0){tB=tmpJB;}
          console.log("Function: z^"+tmpPow+""+tA+""+tB+"i");
          if (tmpIsMandel||tmpJA==0&&tmpJB==0){
            document.getElementById("funcout").innerHTML="Function: z^"+tmpPow+"+c (Mandelbrot set)";
          }else{
            document.getElementById("funcout").innerHTML="Function: z^"+tmpPow+""+tA+""+tB+"i (Julia set)";
          }
        }
      }
      
      function isNumber(inChar){
        for (var a=0;a<10;a++){
          if (inChar==a){return true;}
        }
        if (inChar=="."){return true;}
        return false;
      }
      
      function pushFunction(inId){
        displayFunction();
        advancedGen=false;
        closePopups(0);
        isMandel=tmpIsMandel;
        power=tmpPow;
        julA=tmpJA;
        julB=tmpJB;
        scan=0;
        if (inId==1){resetStuff(); prevH=0;}
        if (inId==1){setStuff();}   //includes mainGenerate()
      }
      
      function pushFunction2(){
        advancedGen=true;
        resetStuff();
        var rePart="0.125",imPart="0.8";
        var input=document.getElementById("functionin2").value;
        var startpos=1,startpos2;
        if (input.endsWith("i")){startpos=2;}
        var endP=0,startP=0;
        for (var a=input.length-startpos;a>0;a--){
          if (input.charAt(a)=="("){startP++;}
          else if (input.charAt(a)==")"){endP++;}
          if (startP==endP&&startP>0){
            startpos2=a-1;
            break;
          }
        }
        var progress=0,skip=false;
        var tmpStr="";
        for (var a=0;a<input.length-startpos+1;a++){
          if (input.charAt(a)=="^"){progress=1;}
          else if (progress>0){
            if (progress==1&&isNumber(input.charAt(a))){
              tmpStr+=input.charAt(a);
            }else if (progress==1){
              power=Math.floor(parseFloat(tmpStr));
              tmpStr="";
              skip=true;
              progress++;
            }
            if (progress==2&&a<startpos2){
              if (tmpStr==""&&input.charAt(a)=='-'&&skip||!skip){tmpStr+=input.charAt(a);}
              skip=false;
            }else if(progress==2){
              rePart=tmpStr;
              tmpStr="";
              progress++;
              skip=true;
            }
            if (progress==3&&a>=startpos2){
              if (tmpStr==""&&input.charAt(a)=='-'&&skip||!skip){tmpStr+=input.charAt(a);}
              skip=false;
            }
          }
        }
        imPart=tmpStr;
        var regex;
        for (var a=0;a<expressions.length;a++){
          regex=new RegExp(expressions[a],"gi");
          rePart=rePart.replace(regex,"Math."+expressions[a]);
          imPart=imPart.replace(regex,"Math."+expressions[a]);
        }
        console.log(power+", "+rePart+", "+imPart);
        var funcName;
        if (functionNo==0){funcName="getJulia(x,y)"}
        else {funcName="getJulia"+functionNo+"(x,y)"}
        functionNo++;
        document.getElementById("customscript").innerHTML="\nfunction redirect(x,y){\n  "+funcName+";\n}\nfunction "+funcName+"{\n  julA="+rePart+";\n  julB="+imPart+";\n}\n";
        isMandel=false;
        closePopups(1);
        scan=0;
        setStuff();
      }
      
      function resetStuff(){
        if (isMandel&&power==2){
          document.getElementById("xOff").value="300";
        }else{
          document.getElementById("xOff").value="0";
        }
        document.getElementById("yOff").value="0";
        document.getElementById("zoom").value="3";
      }
      
      function recolor(){
        paint();
        paint2();
        scan+=10;
      }
      
      function save(){
        if (scan<height&&scan>0){
          alert("Hold your horses!\n\nWait until the fractal has finished rendering!\n");
        }else{
          var c=document.getElementById("mandelcanvas");
          var d=c.toDataURL("image/png");
          var w=window.open('about:blank','image from canvas');
          w.document.write("<img src='"+d+"' alt='from canvas'/>");
        }
      }
      
      function paint(){
        var counter=0;
        for (var h=scan;h<scan+10;h++){
          for (var w=0;w<width;w++){
            if (pixels[h*width+w]==-1){
              /*ctx.fillStyle="black";
              ctx.fillRect(w,h,1,1);*/
              imgData.data[counter]=0;
              imgData.data[counter+1]=0;
              imgData.data[counter+2]=0;
              imgData.data[counter+3]=255;
            }else{
              /*shade=Math.floor((iterations-pixels[h*width+w])/iterations*255);
              ctx.fillStyle="rgb("+shade+","+shade+","+shade+")";*/
              /*color(h*width+w);
              ctx.fillStyle="rgb("+Math.floor(rd)+","+Math.floor(gr)+","+Math.floor(bl)+")";
              ctx.fillRect(w,h,1,1);*/
              color(h*width+w);
              imgData.data[counter]=Math.floor(rd);
              imgData.data[counter+1]=Math.floor(gr);
              imgData.data[counter+2]=Math.floor(bl);
              imgData.data[counter+3]=255;
            }
            counter+=4;
          }
        }
        ctx.putImageData(imgData,0,scan);
        if (scan>=window.innerHeight){
          var time_out;
          if (time<0){
            date=new Date();
            time=date.getTime()+time;
            time_out="Color set in: ";
          }else{
            date=new Date();
            time=date.getTime()-time;
            time_out="Set rendered in: ";
          }
          if (time/60000>=1){
            time_out+=""+Math.floor(time/60000)+"m ";
            time-=(Math.floor(time/60000)*60000);
          }
          if (time/1000>=1){
            time_out+=""+Math.floor(time/1000)+"s ";
            time-=(Math.floor(time/1000)*1000);
          }
          time_out+=""+time+"ms ";
          document.getElementById("upperinfo").style.display="block";
          document.getElementById("upperinfo").innerHTML=time_out;
          setTimeout(function(){document.getElementById("upperinfo").style.display="none";}, 5000);
          clearInterval(thread);
        }
      }
      
      function color(inID){
        var mod=pixels[inID]%cycleLength;
        var percentage=mod/cycleLength;
        var steps=(startAt[selectedCol+1]-startAt[selectedCol])/3;
        for (var i=steps;i>=0;i--){
          if (percentage>=i/steps){
            percentage=(percentage-i/steps)*steps;
            rd=gradientCols[startAt[selectedCol]+3*(i%steps)]+(gradientCols[startAt[selectedCol]+3*((i+1)%steps)]-gradientCols[startAt[selectedCol]+3*(i%steps)])*percentage;
            gr=gradientCols[startAt[selectedCol]+3*(i%steps)+1]+(gradientCols[startAt[selectedCol]+3*((i+1)%steps)+1]-gradientCols[startAt[selectedCol]+3*(i%steps)+1])*percentage;
            bl=gradientCols[startAt[selectedCol]+3*(i%steps)+2]+(gradientCols[startAt[selectedCol]+3*((i+1)%steps)+2]-gradientCols[startAt[selectedCol]+3*(i%steps)+2])*percentage;
            break;
          }
        }
      }
      
      function paint2(){
        ctx2.clearRect(0,0,window.innerWidth,window.innerHeight);
        ctx2.strokeStyle="red";
        if (xRes>0&&yRes>0&&mode==0||move){
          ctx2.beginPath();
          ctx2.rect(xOrig,yOrig,xRes,yRes);
          ctx2.stroke();
        }else if (pressed&&mode==1){
          ctx2.beginPath();
          ctx2.moveTo(0,Math.floor(window.innerHeight/2));
          ctx2.lineTo(window.innerWidth,Math.floor(window.innerHeight/2));
          ctx2.stroke();
          ctx2.beginPath();
          ctx2.moveTo(Math.floor(window.innerWidth/2),0);
          ctx2.lineTo(Math.floor(window.innerWidth/2),window.innerHeight);
          ctx2.stroke();
          var perc=parseFloat(document.getElementById("zoom").value)/zoom;
          var inW=Math.floor(window.innerWidth*perc),inH=Math.floor(window.innerHeight*perc);
          //console.log(inW+" - "+inH);
          ctx2.beginPath();
          ctx2.rect(Math.floor(window.innerWidth/2-inW/2),Math.floor(window.innerHeight/2-inH/2),inW,inH);
          ctx2.stroke();
        }else if(mode==3){
          var tX=event.clientX-cmx,tY=event.clientY-cmy;
          a2=(tX-width/2-xOff/zoom)/(500/zoom);
          b2=(tY-height/2-yOff/zoom)/(500/zoom);
          if (isMandel){
            a=a2;
            b=b2;
          }else{
            a=julA;
            b=-julB;
          }
          ctx2.moveTo(tX,tY);
          generateIndividual(1);
          ctx2.stroke();
        }
        if (thread!=null){
          ctx2.beginPath();
          ctx2.moveTo(0,scan+10);
          ctx2.lineTo(window.innerWidth,scan+10);
          ctx2.stroke();
        }
      }
    </script>
  </head>
  <body onload=init() onkeydown=setMode()>
    <script id="customscript"></script>
    <canvas id="rastercanvas"></canvas>
    <canvas id="mandelcanvas"></canvas>
    <canvas id="overlaycanvas" onmousedown=press(1) onmousemove=canvasInteract() onmouseup=press(0)></canvas>
    <div id="buttonpanel">
      <div id="toolbox" onmousedown=openToolbox()>Tools/hotkeys/about</div>
      <div id="titlebox">
        <div id="title">Max. iterations</div>
        <div id="title">X offset</div>
        <div id="title">Y offset</div>
        <div id="title">Zoom</div>
        <div id="title2">Hotkey: G</div>
        <div id="title2">Hotkey: F</div>
        <div id="title2">Hotkey: C</div>
        <div id="title2">Hotkey: U</div>
      </div>
      <input id="iterations" spellcheck="false" value="50" onkeydown=setMode()></input>
      <input id="xOff" spellcheck="false" value="300" onkeydown=setMode()></input>
      <input id="yOff" spellcheck="false" value="0" onkeydown=setMode()></input>
      <input id="zoom" spellcheck="false" value="3" onkeydown=setMode()></input>
      <button id="generate" onclick=setStuff()>Generate</button>
      <button id="function" onclick=setFunction()>Function</button>
      <button id="colors" onclick=setColor()>Colors</button>
      <button id="geturl" onclick=getUrl()>Get URL</button>
      <button id="save" onclick=save()>Save</button>
      <div id="expando" onclick=expando()>||</div>
    </div>
    <div id="overlay">
      <div id="functionpanel" class="popup" style="height:14vw; margin-top:-7vw">
        Modify Mandelbrot/Julia set function
        <div id="closebtn" onclick="closePopups(0)">[close]</div>
        <input id="functionin" value="z^2+c" spellcheck="false" style="width:41%; top:5.5vw" onkeyup=displayFunction()>
        <button style="margin-top:0;position:absolute;width:12vw;margin-left:27vw;height: 2.4vw;" onclick="setAdvanced()">Advanced</button>
        <button style="margin-top:0;position:absolute;width:12vw;margin-left:40vw;height: 2.4vw;" onclick="pushFunction(1)">Set function</button>
        <div id="funcout" style="display: block; position: absolute; font-size: 1.3vw; color: #555; width: 90%; margin-left: 5%; height: 3vw; line-height: 3vw; background-color: #ddd; margin-top: 4vw;">Function: z^2+c (Mandelbrot set)</div>
      </div>
      <div id="functionpanel2" class="popup" style="height:23vw; margin-top:-11.5vw">
        Advanced Julia set function definition
        <div id="closebtn" onclick="closePopups(1)">[close]</div>
        <input id="functionin2" value="z^2+cos(x)+(sqrt(23)+0.125)i" spellcheck="false" style="width:41%; top:5.5vw" onkeyup=displayFunction()>
        <button style="margin-top:0;position:absolute;width:12vw;margin-left:27vw;height: 2.4vw;" onclick="goBack()">Back</button>
        <button style="margin-top:0;position:absolute;width:12vw;margin-left:40vw;height: 2.4vw;" onclick="pushFunction2()">Set function</button>
        <div id="limitations" style="display: block;position: absolute;font-size: 1vw;color: #555;width: 90%;margin-left: 5%;height: 8vw;line-height: 1.3vw;background-color: #ddd;margin-top: 4vw;">Requirements: integer power (e.g. z^4), imaginary part in complex number must be distincted with parentheses, proceeded by i (e.g. z^2+0.5-(1-sin(x))i).<br><br>Allowed functions/expressions:<br>x, y, PI, E, +, -, *, /, %, pow(x,power), sqrt(x), cbrt(x), sin(x), cos(x), tan(x), floor(x), abs(x), ceil(x), random(max value), log(x), log10(x), exp(x)</div>
        <div id="funcout2" style="display: block;position: absolute;font-size: 1.3vw;color: #555;width: 90%;margin-left: 5%;height: 3vw;line-height: 3vw;background-color: #ddd;margin-top: 13vw;">Function: z^2+c (Mandelbrot set)</div>
      </div>
      <div id="sharepanel" class="popup">
        Share you Mandelbrot/Julia set!
        <div id="closebtn" onclick="closePopups(2)">[close]</div>
        <input id="urlout" spellcheck="false" value="SLUTA GLO MATTIAS! Jag har inte hunnit med allt Ã¤n!"></input>
      </div>
      <div id="colorpanel" class="popup">
        <div class="gradientselector" onmousedown=gradient(0)></div>
        <div class="gradientselector" onmousedown=gradient(1)></div>
        <div class="gradientselector" onmousedown=gradient(2)></div>
        <div class="gradientselector" onmousedown=gradient(3)></div>
        <div class="gradientselector" onmousedown=gradient(4)></div>
        <div class="gradientselector" onmousedown=gradient(5)></div>
        <div class="gradientselector" onmousedown=gradient(6)></div>
        <div class="gradientselector" onmousedown=gradient(7)></div>
        <div class="gradientselector" onmousedown=gradient(8)></div>
        <div class="gradientselector" onmousedown=gradient(9)></div>
        <div id="gradientdisplay"></div>
      </div>
      <div id="infocontainer" class="popup">
        <div id="closebtn" onclick="closePopups(-1)">[close]</div>
        <div id="inner">
          <h>Tools/hotkeys</h>
          <p>
            <b>S - Scale mode</b> Click and drag to select a part of a fractal. You can move the selection around if needed.
            <br><br>
            <b>M - Move mode</b> Drag the entire rendered image and re-render. If a different zoom value is input, a rectangular selection box will appear in the center.
            <br><br>
            <b>E - Escape mode</b> Move your cursor over the set. The script will display the positions of complex numbers for each cycle of the rendering algorithm until it escapes.
            <br><br>
            <b>I - Info mode</b> Move your cursor over the set. It will display the amount of iterations and position for that point.
            <br><br>
            <b>G - Generate</b> Generate a new set. Edit the function in the function panel.
            <br><br>
            <b>F - Function (ordinary)</b> Edit the function used to render a fractal. It's not picky with the input, but requires one constant for a Mandelbrot set (power, default is 2), and two or more constant for Julia sets. Note that the script automatically selects which settings are input if only two constants are present. z^2-0.5 will be parsed as z^2-0.5+0i and z^2-0.5i as z^2+0-0.5i.
            <br><br>
            <b>F- Function (advanced)</b> Edit the function, but with more advanced input. This mode supports more advanced mathematical operations to describe constants in Julia sets, such as trigonometry, roots, and variables (x and y).
            <br><br>
            <b>C - Color scheme</b> Set a different color scheme for your set. The mod value describes how often colors are repeated. 
            <br><br>
            <b>U - get URL</b> Get the shareable URL for your set!
            <br><br>
            <b>Esc</b> Pretty basic stuff. Closes popups.
            <br><br>
            <b>Enter</b> Generate new set.
          </p>
          <h2>About - Mandelbrot and Julia sets</h2>
            <p>
              <b>Complex numbers</b> Mandelbrot/Julia sets are fractals based on the properies of complex numbers, written as a+bi, where a and b are real numbers and i is an imaginary unit, equal to the square root of -1. For the record, bi=b*i, which makes bi an imaginary number, with b as a "real number coefficient". All complex numbers can be plotted in a two-dimensional coordinate system, the complex plane, where a represents values on the real axis (x-axis), and bi represents the imaginary axis, thus taking on the role of the y-axis in the normal coordinate system. Every complex number in the system is represented by a point. 2+3i is a point two steps away from the origin along the x-axis, and three steps away from the origin along the y-axis, for instance.
              <br><br>
              <b>How Mandelbrot sets are generated pt. 1: Iterations</b> The mandelbrot set follows this formula: z^2+c, where z is the complex number from the previous iteration (I'll explain what that means in a second), and c is the complex number described by the point that is generated. Okay, this sounds confusing, so let's begin with c. A generated set is an image, and so contains a lot of pixels. Imagine each of those pixels is a point in the complex plane, which makes each pixel describe a complex number c which changes for every pixel position in the image. Now, I said z was the result of the previous iteration, so here's how this works: We start by saying z=0 (0+0i, if you're pedantic), and so z^2+c=c. Now, take the result (=c) and put it into the formula, c^2+c=d. And again, d^2+c=e, and again, e^2+c=f, etc. c,d,e, and f are all complex numbers. The next step is to investigate how these new numbers behave.
              <br><br>
              <b>How Mandelbrot sets are generated pt. 2: Escape time</b> Okay, let's investigate the new numbers. We need to get a grasp of where these new numbers lie in the complex plane, so we use the absolute value of the complex number. It might sound fancy, but it's basically just the hypotenuse in a right triangle with sides a and b. abs(c)=sqrt(a^2+b^2). The good thing is that we get a single value, and best of all, it's a real number!. If the absolute is small, that means that the complex number is close to the origin, and the opposite if the absolute is large. It has been proven that if the absolute exceeds 2, no new generated complex number will have an absolute value less than 2, and thus diverge to infinity. If, for any value of c, the sequence diverges, it doesn't belong to the Mandelbrot set. If, on the other hand, no new number reaches an absolute of 2+ during a set number of iterations, it does. The time (number of iterations) it takes for a series to reach abs(z^2+c)>2 is called the escape time.
              <br><br>
              <b>How Mandelbrot sets are generated pt. 3: Colors</b> This part is pretty easy. If the sequence remains bounded, i.e. no complex number in the series has an absolute value larger than 2, that pixel is colored black, to show it belongs in the set. Conversely, if it has escaped, a color is picked according to escape time. That's what causes those beautiful color gradients!
              <br><br>
              <b>What about Julia sets, then?</b> The mandelbrot set uses the form z^2+c, and Julia sets use the form z^2+a+bi, with the first value of z=c, instead of 0! That's as complex (heh) as it gets! Instead of a variable, a Julia set uses a single complex number for each pixel. Otherwise, they're generated the same way as Mandelbrot sets.
              <br><br>
              <b>Searching for a higher power?</b> The Mandelbrot set was first defined, as z^2+c, but any other power will work, such as z^4+c. This web app accepts any integer power value larger or equal to 2. For power 2, the code uses a simple formula to generate the next number. For higher powers, this becomes inefficient. Therefore, de Moivre's formula, which lets you put in any power and spits out the complex number in polar form. This way, Mandelbrot/Julia sets with powers exceeding 100 is fully possible to generate and live to see finish generating!
            </p>
          <h2>About - creator</h2>
            <p>
              This web app was written by reddit user /u/PicturElements in June 2016. 
              <br>
              License: <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/">CC BY-NC-SA 3.0</a> - You are allowed to edit, share and improve my work, given that appropriate credit is given.
            </p>
        </div>
      </div>
    </div>
    <div id="hoverinfo">
      <div id="colorsample"></div>
      <div id="iterationinfo"></div>
      <div id="iterationinfo2"></div>
    </div>
    <div id="upperinfo"></div>
  </body>
</html>
